{% extends "layouts/base.html" %}
{% load static %}
{% load pretify_status %}
{% load humanize %}
{% block custom_page_css %}
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
{% endblock %}
{% block browser_title %}Modify Gig/Project{% endblock %}
{% block content %}
<div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-7 md:mb-0">
    <!-- Left: Title & Breadcrumbs Context -->
    <div class="flex flex-col gap-1 my-6">
        <div class="flex items-center gap-3 flex-wrap">
            <h1 class="text-xl md:text-2xl font-semibold text-slate-900 dark:text-white truncate max-w-md">
                {{ gig.title|striptags|title }}
            </h1>
            <div class="flex items-center gap-2">
                {% if gig.visibility == 'public' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success-500/10 dark:bg-emerald-500/10 text-emerald-500 dark:text-emerald-500 border border-success-500/20 dark:border-emerald-500/20">
                    <span class="material-symbols-outlined text-[14px] mr-1">public</span>
                    Public
                </span>
                {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700 border border-purple-200">
                    <span class="material-symbols-outlined text-[14px] mr-1">lock</span>
                    Private
                </span>
                {% endif %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                    {% if gig.status == 'draft' %}
                        bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200 border border-gray-200
                    {% elif gig.status == 'pending' %}
                        bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200 border border-amber-200
                    {% elif gig.status == 'published' %}
                        bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 border border-indigo-200
                    {% elif gig.status == 'in_progress' %}
                        bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200 border border-emerald-200
                    {% elif gig.status == 'completed' %}
                        bg-success-100 text-success-800 dark:bg-success-900 dark:text-success-200 border border-success-200
                    {% else %}
                        bg-error-100 text-error-800 dark:bg-error-900 dark:text-error-200 border border-error-200
                    {% endif %}
                    ">
                    {{ gig.status|prettify_status }}
                </span>
            </div>
        </div>
    </div>
    <!-- Right: Actions -->
    <div
        x-data="{ busy: false }" 
        class="flex items-center gap-2 self-start md:self-center">
        <a
            href="{% url COLLABORATION_URLS.DETAIL_COLLABORATION slug=gig.slug %}"
            @click="if (busy) return; window.location.href = $el.href"
            :class="{
                'pointer-events-none cursor-not-allowed opacity-60': busy
            }"
            class="flex items-center justify-center gap-2 px-4 h-10 rounded-lg
                border border-slate-200 dark:border-slate-700
                bg-white dark:bg-slate-800
                text-slate-500 dark:text-slate-200
                font-bold text-sm
                hover:border-brand-500 hover:text-brand-500
                transition-colors"
        >
            <span x-show="!busy" class="material-symbols-outlined text-[18px]">arrow_left_alt</span>
            <span x-show="busy" class="material-symbols-outlined text-[18px] animate-pulse">hourglass_top</span>
            
            <span class="hidden sm:inline" x-show="!busy">Go Back</span>
            <span class="hidden sm:inline" x-show="busy">Please wait...</span>
        </a>

        <button 
            @click="
                if (busy) return;
                busy = true;
                saveChanges().finally(() => busy = false)
            "
            :disabled="busy"
            class="flex items-center justify-center 
                gap-2 px-6 h-10 rounded-lg bg-brand-500 
                hover:bg-brand-400 text-white font-bold 
                text-sm shadow-md shadow-brand-500/20 
                transition-all active:scale-95
                disabled:opacity-60 disabled:cursor-not-allowed
            "
        >
            <span x-show="!busy" class="material-symbols-outlined text-[18px]">save</span>
            <span x-show="busy" class="material-symbols-outlined text-[18px] animate-spin">sync</span>
            <span x-show="!busy">Save Changes</span>
            <span x-show="busy">Savingâ€¦</span>
        </button>
    </div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <div 
        data-gig-data x-data="updateGigData($el)" 
        data-title="{{ gig.title|striptags|title }}" 
        data-visibility="{{ gig.visibility }}" 
        data-budget="{{ gig.total_budget }}" 
        data-description="{{ gig.description|escape }}" 
        data-start-date="{{ gig.start_date|date:'Y-m-d' }}"
        data-end-date="{{ gig.end_date|date:'Y-m-d' }}" 
        data-endpoint="{% url COLLABORATION_URLS.EDIT_COLLABORATION slug=gig.slug %}" 
        data-csrf-token="{{ csrf_token }}" 
        data-status="{{ gig.status }}" 
        class="lg:col-span-8 flex flex-col gap-6"
    >
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="flex items-center gap-2 mb-6 border-b border-slate-100 dark:border-slate-700 pb-4">
                <span class="p-2 bg-brand-50 dark:bg-gray-600 dark:brand-600/30 rounded-lg material-symbols-outlined text-[20px] text-brand-500 dark:text-gray-400">article</span>
                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Basic Gig Information</h3>
            </div>
            <div class="grid gap-6">
                <div class="space-y-3">
                    <label class="block ml-1.5 text-gray-700 dark:text-gray-400 text-sm font-semibold">Gig Title</label>
                    <input 
                        x-model="payload.title" 
                        :disabled="locked" 
                        class="custom-form-input"
                        :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''" 
                        type="text" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block ml-1.5 text-gray-700 dark:text-gray-400 text-sm font-semibold">Visibility</label>
                        <div class="relative">
                            <select 
                                x-model="payload.visibility"
                                :disabled="locked" 
                                :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''" 
                                class="custom-form-input appearance-none">
                                <option value="public">Public (Visible to everyone)</option>
                                <option value="private">Private (Invite only)</option>
                                <!-- <option value="internal">Internal Team Only</option> -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                                <span class="material-symbols-outlined">expand_more</span>
                            </div>
                        </div>
                    </div>

                    <!-- Budget -->
                    <div class="">
                        <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">Total Project Budget</label>
                        <div class="mt-1 relative rounded-lg shadow-sm space-y-2">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500 text-sm font-medium pointer-events-none">
                                $
                            </span>
                            <input 
                                x-model="payload.projectBudget" :disabled="budgetLocked" :class="budgetLocked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''" type="number" class="custom-form-input pl-6" />
                        </div>
                        <!-- <p class="text-xs text-slate-500">excludin platform fees.</p> -->
                    </div>
                </div>
            </div>
        </section>
        <!-- Description Card -->
        <section class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-fuchsia-50 dark:bg-gray-600 rounded-lg p-2 material-symbols-outlined text-fuchsia-500 dark:text-gray-400">description</span>
                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Gig Description</h3>
            </div>
            <div x-init="initQuill()" class="border border-slate-300 dark:border-slate-600 
                    rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-900 
                    focus-within:border-success-300 dark:focus-within:border-warning-200 
                    focus-within:ring-success-500/10 transition-all">
                <!-- Toolbar -->
                <div id="quill-toolbar" class="flex flex-wrap items-center gap-x-2 gap-y-2 p-2 border-b 
                    border-slate-200 dark:border-slate-700 
                    bg-slate-100 dark:bg-slate-800">
                    <!-- Header -->
                    <div class="relative">
                        <select class="ql-header">
                            <option selected value="">Paragraph</option>
                            <option value="2">H2</option>
                            <option value="3">H3</option>
                            <option value="4">H4</option>
                            <option value="5">H5</option>
                        </select>
                    </div>

                    <!-- Buttons -->
                    <button class="ql-bold quill-btn"><span class="material-symbols-outlined">format_bold</span></button>
                    <button class="ql-italic quill-btn"><span class="material-symbols-outlined">format_italic</span></button>
                    <button class="ql-underline quill-btn"><span class="material-symbols-outlined">format_underlined</span></button>

                    <!-- Alignment -->
                    <button class="ql-align quill-btn" value="">
                        <span class="material-symbols-outlined">format_align_left</span>
                    </button>
                    <button class="ql-align quill-btn" value="center">
                        <span class="material-symbols-outlined">format_align_center</span>
                    </button>
                    <button class="ql-align quill-btn" value="right">
                        <span class="material-symbols-outlined">format_align_right</span>
                    </button>
                    <button class="ql-align quill-btn" value="justify">
                        <span class="material-symbols-outlined">format_align_justify</span>
                    </button>

                    <!-- Bullet list-->
                    <button class="ql-list quill-btn" value="bullet">
                        <span class="material-symbols-outlined">format_list_bulleted</span>
                    </button>

                </div>
                <div id="quill-editor" class="w-full min-h-[200px] p-4 bg-transparent text-gray-800 dark:text-gray-400"></div>
                <!-- Text Area --
                <textarea 
                    x-model="payload.description" 
                    @input="enforceDescriptionLimit()" 
                    :disabled="locked" 
                    :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''" 
                    class="w-full border-none bg-transparent p-4 min-h-[160px]
                        text-gray-800 dark:text-gray-400
                        placeholder:text-gray-500
                        focus:outline-none focus:ring-0 
                        focus:border-transparent"
                ></textarea> -->
            </div>
            <div class="flex justify-end mt-2 text-xs" :class="descriptionCount() >= maxDescriptionLength
                    ? 'text-red-500'
                    : 'text-slate-500'">
                <span x-text="descriptionCount()"></span> /<span x-text="` ${maxDescriptionLength}`"></span>
                characters
            </div>
        </section>
        <!-- Roles Section -->
        <section x-data="gigRoles($refs.taxonomy, $refs.workmodeData, $refs.rolesData, locked)" data-gig-roles class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <span class="bg-amber-50 dark:bg-gray-600 rounded-lg p-2 material-symbols-outlined text-amber-500 dark:text-gray-400">group</span>
                    <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Required Roles</h3>
                </div>
                <button @click="addRole()" class="text-gray-400 hover:text-brand-500 dark:hover:text-gray-300 text-sm font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-[18px]">add</span> Add new role
                </button>
            </div>
            <div class="space-y-4">
                <!-- Role Card 1 (Filled/Lockedish) -->
                <template x-for="(role, index) in roles" :key="index">
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg bg-[#fcfcfd] dark:bg-gray-800 p-5 relative group transition-all hover:border-success-500/50">
                        <!-- Header -->
                        <div class="absolute top-4 right-4 flex gap-2">
                            <span
                                class="inline-flex items-center px-2 py-1 rounded text-xs font-medium"
                                :class="role.isNew
                                    ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300'
                                    : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'"
                                x-text="role.isNew ? 'New' : 'Active'"
                            ></span>
                            <span
                                x-show="!role.isNew"
                                x-transition.opacity
                                class="inline-flex items-center px-2 py-1 
                                    rounded text-xs font-medium gap-1.5
                                    bg-purple-100 text-purple-700 
                                    dark:bg-purple-900 dark:text-purple-300"
                            >
                                slots:<span x-text="role.slots" class="text-xs"></span>
                            </span>
                            <button @click="removeRole(index)" class="text-slate-400 hover:text-red-500">
                                <span class="material-symbols-outlined text-[20px]">delete</span>
                            </button>
                        </div>

                        <h4 class="text-sm font-semibold text-gray-800 dark:text-white mb-4">
                            Role No. <span x-text="index + 1"></span>
                        </h4>

                        <!-- Niche & Professional -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Niche -->
                            <div>
                                <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">
                                    Niche
                                </label>
                                <select
                                    x-model="role.nicheId"
                                    :disabled="locked"
                                    :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                                    @change="role.professionalId=''; emitRoles()"
                                    class="w-full rounded-md border border-[#cfd7e7]
                                        dark:border-[#4a5568] bg-white dark:bg-slate-900
                                        text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm
                                        focus:outline-none focus:ring-1 focus:ring-success-500/30
                                        focus:border-success-500 transition"
                                >
                                    <option x-text="role.nicheName"></option>
                                    <template x-for="niche in taxonomy" :key="niche.id">
                                        <option :value="niche.id" x-text="niche.name"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- Professional -->
                            <div>
                                <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">
                                    Specialization
                                </label>

                                <select
                                    x-model="role.professionalId"
                                    :disabled="locked"
                                    :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                                    @change="emitRoles()"
                                    class="w-full rounded-md border border-[#cfd7e7]
                                        dark:border-[#4a5568] bg-white dark:bg-slate-900
                                        text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm
                                        focus:outline-none focus:ring-1 focus:ring-success-500/30
                                        focus:border-success-500 transition"
                                >
                                    <option x-text="role.professionalName"></option>
                                    <template x-for="pro in professionalsFor(role.nicheId)" :key="pro.id">
                                        <option :value="pro.id" x-text="pro.name"></option>
                                    </template>
                                </select>
                            </div>
                        </div>
                        <!-- Budget & Workload -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Budget -->
                            <div>
                                <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">
                                    Allocated Budget
                                </label>

                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 
                                        text-gray-400 dark:text-gray-500 text-sm font-medium pointer-events-none">
                                        $
                                    </span>

                                    <input
                                        type="number"
                                        x-model="role.budget"
                                        @input="emitRoles()"
                                        min="0"
                                        :disabled="locked"
                                        :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                                        class="w-full rounded-md border border-[#cfd7e7]
                                            dark:border-[#4a5568] bg-white dark:bg-slate-900
                                            text-gray-800 dark:text-gray-400 pl-7 pr-3 py-2.5 text-sm
                                            focus:outline-none focus:ring-1 focus:ring-success-500/30
                                            focus:border-success-500"
                                    />
                                </div>
                            </div>

                            <!-- Workload -->
                            <div>
                                <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">
                                    Workload
                                </label>

                                <select
                                    x-model="role.workload"
                                    @change="emitRoles()"
                                    :disabled="locked"
                                    :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                                    class="w-full rounded-md border border-[#cfd7e7]
                                        dark:border-[#4a5568] bg-white dark:bg-slate-900
                                        text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm
                                        focus:outline-none focus:ring-1 focus:ring-success-500/30
                                        focus:border-success-500 transition"
                                >
                                    <option value="">modify workload</option>
                                    <template x-for="mode in workmodeOptions" :key="mode.value">
                                        <option :value="mode.value" x-text="mode.label"></option>
                                    </template>
                                </select>
                            </div>

                        </div>

                        <!-- Description -->
                        <div class="grid grid-cols-1">
                            <div>
                                <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">
                                    Role Description
                                </label>

                                <textarea
                                    rows="6"
                                    x-model="role.description"
                                    @input="emitRoles()"
                                    :disabled="locked"
                                    :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                                    class="w-full rounded-md border border-[#cfd7e7] leading-relaxed
                                        dark:border-[#4a5568] bg-white dark:bg-slate-900 
                                        text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm md:text-base 
                                        focus:outline-none focus:ring-1 focus:ring-success-500/30 
                                        focus:border-success-500 transition resize-y"
                                ></textarea>
                            </div>
                        </div>

                    </div>
                </template>
                <!-- Add Role Placeholder -->
                <button 
                    @click="addRole()" 
                    :disabled="locked"
                    :class="locked 
                        ? 'opacity-40 cursor-not-allowed pointer-events-none' 
                        : 'hover:border-brand-500 hover:text-brand-500'"
                    class="w-full py-4 border-2 border-dashed border-slate-300 
                        dark:border-slate-700 rounded-lg text-slate-500 
                        hover:border-brand-500 hover:text-brand-500
                        dark:hover:border-gray-400 dark:hover:text-gray-300
                        hover:bg-brand-500/5 transition-all flex flex-col 
                        items-center justify-center gap-2 group"
                >
                    <div class="p-2 rounded-full bg-slate-100 dark:bg-slate-800 group-hover:bg-brand-500/10 transition-colors">
                        <span class="material-symbols-outlined group-hover:text-brand-500 transition-colors">add</span>
                    </div>
                    <span class="text-sm font-bold">Add another role</span>
                </button>
            </div>
        </section>
        <!-- Timeline Section -->
         
        <section 
            class="bg-[#fcfcfd] dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 relative overflow-hidden"
        >
            <!-- Locked Overlay (only when in progress) -->
            <div 
                x-show="locked"
                x-transition.opacity
                class="absolute top-4 right-4 z-10"
            >
                <div class="group relative flex items-center">
                    <span class="material-symbols-outlined text-slate-400 cursor-help">lock</span>

                    <span class="absolute right-full mr-2 w-48 p-2 bg-slate-800 text-white text-xs rounded 
                                opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                        Dates cannot be changed while gig is In Progress.
                    </span>
                </div>
            </div>

            <!-- Header -->
            <div class="flex items-center gap-2 mb-6 pb-4 border-b border-slate-200 dark:border-slate-700">
                <span class="material-symbols-outlined bg-teal-50 dark:bg-gray-600 rounded-lg p-2 text-teal-500 dark:text-gray-400">
                    calendar_today
                </span>
                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">
                    Timeline &amp; Milestones
                </h3>
            </div>


            <!-- Timeline Inputs -->
            <div 
                class="grid grid-cols-1 md:grid-cols-2 gap-6"
                :class="locked ? 'opacity-70' : ''"
            >
                <!-- Start Date -->
                <div class="space-y-2">
                    <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">
                        Start Date
                    </label>

                    <input 
                        type="date"
                        x-model="payload.startDate"
                        :disabled="locked"
                        :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                        class="w-full rounded-md border border-[#cfd7e7]
                            dark:border-[#4a5568] bg-white dark:bg-slate-900
                            text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm md:text-base
                            focus:outline-none focus:ring-1 focus:ring-success-500/30
                            focus:border-success-500 transition"
                    />
                </div>

                <!-- End Date -->
                <div class="space-y-2">
                    <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">
                        Estimated End Date
                    </label>

                    <input 
                        type="date"
                        x-model="payload.endDate"
                        :disabled="locked"
                        :class="locked ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800' : ''"
                        class="w-full rounded-md border border-[#cfd7e7]
                            dark:border-[#4a5568] bg-white dark:bg-slate-900
                            text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm md:text-base
                            focus:outline-none focus:ring-1 focus:ring-success-500/30
                            focus:border-success-500 transition"
                    />
                </div>
            </div>
            <!-- <div class="my-3 text-xs text-red-500" x-text="'Locked: ' + locked"></div> -->
        </section>

    </div>
    <!-- Right Column: Sidebar -->
    <div class="lg:col-span-4 space-y-6">
        <!-- Status Widget -->
        <!-- <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Gig Status</h3>
            <div class="flex items-start gap-3 mb-4">
                <div class="mt-1 size-3 rounded-full bg-amber-500 animate-pulse"></div>
                <div>
                    <p class="text-lg font-bold text-slate-900 dark:text-white leading-tight">Active &amp; In Progress</p>
                    <p class="text-sm text-slate-500 mt-1">This gig is currently live. Roles are being filled and work has started.</p>
                </div>
            </div>
            <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2 mb-2">
                <div class="bg-brand-500 h-2 rounded-full" style="width: 35%"></div>
            </div>
            <p class="text-xs text-right text-slate-500">35% Budget Utilized</p>
        </div> -->
        <!-- Quick Actions -->
        <!-- <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Quick Actions</h3>
            <div class="flex flex-col gap-2">
                <button class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 group transition-colors text-left">
                    <div class="flex items-center gap-3">
                        <div class="size-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-[18px]">handshake</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-700 dark:text-slate-200 group-hover:text-brand-500">View Negotiations</span>
                    </div>
                    <span class="material-symbols-outlined text-slate-400 text-[16px]">arrow_forward</span>
                </button>
                <button class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 group transition-colors text-left">
                    <div class="flex items-center gap-3">
                        <div class="size-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-[18px]">payments</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-700 dark:text-slate-200 group-hover:text-brand-500">View Payments</span>
                    </div>
                    <span class="material-symbols-outlined text-slate-400 text-[16px]">arrow_forward</span>
                </button>
                <button class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 group transition-colors text-left">
                    <div class="flex items-center gap-3">
                        <div class="size-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                            <span class="material-symbols-outlined text-[18px]">chat</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-700 dark:text-slate-200 group-hover:text-brand-500">Team Chat</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="bg-red-500 text-white text-[10px] px-1.5 rounded-full font-bold">2</span>
                        <span class="material-symbols-outlined text-slate-400 text-[16px]">arrow_forward</span>
                    </div>
                </button>
            </div>
        </div> -->
        <!-- Activity & Metadata -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Activity &amp; Metadata</h3>
            <div class="space-y-4">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-slate-400 mt-0.5 text-[18px]">history</span>
                    <div>
                        <p class="text-xs text-slate-500">Last updated</p>
                        <p class="text-sm font-medium text-gray-700 dark:text-white">{{ gig.updated_display }}</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-slate-400 mt-0.5 text-[18px]">calendar_add_on</span>
                    <div>
                        <p class="text-xs text-slate-500">Created on</p>
                        <p class="text-sm font-medium text-slate-700 dark:text-white">{{ gig.created_at|date:"M j, Y" }}</p>
                    </div>
                </div>
                <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                    <p class="text-xs text-slate-500 mb-2">Active Collaborators</p>
                    <!-- {%  for role in gig.required_roles.all %}
                        {% for application in role.applications.all %}
                            <div class="flex -space-x-2 overflow-hidden">
                                <div class="inline-block size-8 rounded-full ring-2 ring-white dark:ring-slate-800 bg-cover bg-center" data-alt="Collaborator avatar 1" style='background-image: url("/static/images/user/user-01.jpg");'></div>
                                <div class="inline-block size-8 rounded-full ring-2 ring-white dark:ring-slate-800 bg-cover bg-center" data-alt="Collaborator avatar 2" style='background-image: url("/static/images/user/user-02.jpg");'></div>
                                <div class="inline-block size-8 rounded-full ring-2 ring-white dark:ring-slate-800 bg-cover bg-center" data-alt="Collaborator avatar 2" style='background-image: url("/static/images/user/user-03.jpg");'></div>
                                <div class="inline-block size-8 rounded-full ring-2 ring-white dark:ring-slate-800 bg-cover bg-center" data-alt="Collaborator avatar 2" style='background-image: url("/static/images/user/user-04.jpg");'></div>
                                <div class="inline-block size-8 rounded-full ring-2 ring-white dark:ring-slate-800 bg-cover bg-center" data-alt="Collaborator avatar 2" style='background-image: url("/static/images/user/user-05.jpg");'></div>
                                <div class="inline-block size-8 rounded-full py-2 px-1.5 
                                        ring-2 ring-white dark:ring-slate-800 
                                        bg-slate-200 dark:bg-slate-700 items-center 
                                        justify-center text-xs font-bold text-slate-500
                                    ">
                                    +3
                                </div>
                            </div>
                        {% empty %}
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full border border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[16px] text-gray-400">person_add</span>
                                </div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">No applicants yet</span>
                            </div>
                        {% endfor %}
                    {% endfor %} -->
                    {% with applications=gig.all_applications %}
                        {% if applications %}
                            <div class="flex -space-x-2 overflow-hidden">
                                {% for applicants in applications|slice:":5" %}
                                    <div 
                                        class="inline-block size-8 rounded-full 
                                            ring-2 ring-white dark:ring-slate-800 
                                            bg-cover bg-center" 
                                        data-alt="{{ application.user.get_full_name }} avatar"
                                        style="background-image: url('{{ applicants.user.avatar_url }}');">
                                    </div>
                                {% endfor %}
                                {% if applications|length > 5 %}
                                    <div class="inline-flex size-8 items-center justify-center
                                        ring-2 ring-white dark:ring-slate-800 
                                        bg-slate-200 dark:bg-slate-700 
                                        text-xs font-bold text-slate-500">
                                        +{{ applications|length|add:"-5" }}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full border border-dashed border-gray-300 dark:border-gray-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[16px] text-gray-400">person_add</span>
                                </div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">No applicants yet</span>
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block custom_page_js %}
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script id="gig-taxonomy-data" type="application/json" x-ref="taxonomy">
    {{ gig_taxonomy|safe }}
</script>
<script id="workmode-data" type="application/json" x-ref="workmodeData">
    {{ workmode_labels|safe }}
</script>
<script id="gig-roles-data" type="application/json" x-ref="rolesData">
    {{ gig_roles_json|safe }}
</script>
<script>
    function gigRoles(taxonomyEl, workmodeEl, rolesEl, locked) {
        return {
            locked,
            taxonomy: JSON.parse(taxonomyEl.textContent),
            workmodeOptions: JSON.parse(workmodeEl.textContent),

            roles: JSON.parse(rolesEl.textContent || "[]"),

            init() {
                this.roles = this.roles.map(role => ({
                    ...role,
                    isNew: false
                }));
                this.emitRoles();
            },

            professionalsFor(nicheId) {
                return this.taxonomy.find(n => n.id == nicheId)?.subcategories || [];
            },

            addRole() {
                if (this.locked) return;

                this.roles.push({ 
                    nicheId: '',
                    nicheName: '',
                    professionalId: '',
                    professionalName: '',
                    budget: 0,
                    description: '',
                    workload: 'flexible',
                    isNew: true,
                });

                this.emitRoles();
            },

            removeRole(index) {
                if (this.locked) return;

                this.roles.splice(index, 1);
                this.emitRoles();
            },

            emitRoles() {
                const gigEl = document.querySelector('[data-gig-data]');
                if (!gigEl) return;

                const gig = Alpine.$data(gigEl);
                if (!gig?.setRoles) return;

                const payload = this.roles.map(role => {
                    const niche = this.taxonomy.find(n => n.id == role.nicheId);
                    const professional = niche?.subcategories?.find(p => p.id == role.professionalId);

                    return {
                        nicheId: role.nicheId,
                        niche: niche?.name || role.nicheName,
                        professionalId: role.professionalId,
                        professional: professional?.name || role.professionalName,
                        budget: Number(role.budget) || 0,
                        description: role.description?.trim() || '',
                        workload: role.workload
                    };
                });

                gig.setRoles(payload);
            },

            totalRolesBudget() {
                return this.roles.reduce(
                    (sum, r) => sum + (Number(r.budget) || 0),
                    0
                );
            },
        }
    }
</script>
<script src="{% static 'js/collaboration/update-gig.js' %}"></script>
{% endblock %}