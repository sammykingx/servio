{% extends "layouts/base.html" %}
{% load static %}
{% load humanize %}
{% block browser_title %}Accept Project{% endblock %}
{% block custom_page_css %}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
{% endblock %}
{% block content %}
<section class="flex flex-col flex-1 max-w-[1200px] mx-auto w-full px-2 py-8 gap-8">
    <div class="flex flex-col gap-4">
        <!-- Title Row -->
        <div class="flex items-center gap-3">

            <!-- Accent Bar -->
            <div class="h-8 w-1.5 rounded-full bg-brand-600/90"></div>

            <div>
                <h2 class="text-title-sm md:text-title-md font-semibold
                    text-slate-900 dark:text-white
                    tracking-tight leading-tight mb-2">
                    Apply to Project
                </h2>

                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">
                    Submitting your proposal for
                    <span class="text-slate-700 dark:text-slate-300 font-semibold">
                        {{ gig.title|truncatewords:8|title }}
                    </span>
                </p>
            </div>

        </div>

    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
        <div class="lg:col-span-2 flex flex-col gap-8">
            <section 
                id="gig-summary-section" 
                data-has-roles="{{ gig.has_gig_roles|yesno:'true,false' }}" 
                data-end-date="{{ gig.end_date }}" 
                data-csrf-token="{{ csrf_token }}"
                data-end-point="{% url OPPURTUNITIES.ACCEPT_OFFER slug=gig.slug %}" 
                class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-6">
                <h3 class="text-base font-semibold tracking-tight text-slate-900 dark:text-white mb-5">
                    Gig Summary
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Commencement Date -->
                    <div class="flex items-center gap-4 rounded-xl 
						bg-fuchsia-50/80 dark:bg-fuchsia-800/40 p-3">
                        <div class="flex size-8 items-center justify-center 
							rounded-lg bg-fuchsia-500/10 text-fuchsia-600 dark:text-fuchsia-400">
                            <span class="material-symbols-outlined">calendar_check</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[11px] uppercase tracking-wider 
								text-slate-500 dark:text-slate-400">
                                Project Timeline
                            </span>
                            <span class="text-sm font-medium text-slate-900 dark:text-white">
                                {{ gig.start_date|date:"M d" }} – {{ gig.end_date|date:"M d" }}
                            </span>
                        </div>
                    </div>
                    <!-- Timeline -->
                    <div class="flex items-center gap-4 rounded-xl 
						bg-amber-50/80 dark:bg-amber-800/40 p-3">
                        <div class="flex size-8 items-center justify-center 
							rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-400">
                            <span class="material-symbols-outlined">calendar_clock</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[11px] uppercase tracking-wider 
								text-slate-500 dark:text-slate-400">
                                Estimated Duration
                            </span>
                            <span class="text-sm font-medium text-slate-900 dark:text-white">
                                {{ gig.gig_duration }}
                            </span>
                        </div>
                    </div>
                    <!-- Project budget -->
                    <div class="flex items-center gap-4 rounded-xl 
						bg-emerald-50/80 dark:bg-emerald-800/40 p-3">
                        <div class="flex size-8 items-center justify-center 
							rounded-lg bg-emerald-500/10 text-emerald-600 dark:text-emerald-400">
                            <span class="material-symbols-outlined">account_balance_wallet</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[11px] uppercase tracking-wider 
								text-slate-500 dark:text-slate-400">
                                Project Budget
                            </span>
                            <span class="text-sm font-medium text-slate-900 dark:text-white">
                                {{ gig.dynamic_range }}
                            </span>
                        </div>
                    </div>
                </div>
            </section>

            <div class="bg-white dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
				<div class="p-6 flex flex-col gap-6">
					<div>
						<h3 class="text-base font-semibold tracking-tight text-slate-900 dark:text-white">Project Description</h3>
						<div class="quill-content max-w-none text-gray-500 dark:text-gray-4=600 space-y-4 leading-relaxed">
							{{ gig.description|safe }}
						</div>
					</div>
					<div class="pt-4 border-t border-slate-100 dark:border-slate-800">
						<p class="mb-3 text-slate-500 dark:text-slate-400 text-xs leading-relaxed">
                            <span class="font-semibold text-brand-400 dark:text-brand-300">Critical:</span> Review the project requirements thoroughly. Your proposal deliverables and dates will form the basis of the binding agreement.
                        </p>
					</div>
				</div>
			</div>

            
            <section 
                class="flex flex-col gap-4" 
                x-data="roleApplicationManager([
                    {% for role in roles %}
                    {
                        industry_id: {{ role.niche_id }},
                        niche_id: {{ role.role_id }},
                        niche_name: '{{ role.niche_name }}',
                        role_amount: {{ role.budget|default:0 }},
                        payment_plan: '{{ role.payment_option }}',
                        is_active: false,
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ])" 
                x-ref="roleApplicationsUnit"
            >
                {% if roles %}
                    <div class="flex flex-col">
                        <h3 class="text-base font-semibold tracking-tight text-slate-900 dark:text-white">Select Your Role</h3>
                        <span class="text-xs font-light text-slate-400 uppercase">Multiple Selection Allowed if qualified</span>
                    </div>
                    <div class="grid grid-cols-1 gap-5">
                        {% for role in roles %}
                            {% if role.can_apply %}
                                <label class="relative group cursor-pointer">
                                    <!-- Hidden Checkbox -->
                                    <input 
                                        type="checkbox" 
                                        class="sr-only role-checkbox"
                                        :checked="isRoleActive({{ role.role_id }})"
                                        data-role-id="{{ role.niche_id }}"
                                        data-can-apply="{{ role.can_apply|yesno:'true,false' }}"
                                        @change="toggleRole({{ role.role_id }})"
                                    />
                                    <!-- Subtle Ambient Glow -->
                                    <div class="absolute -inset-1 rounded-2xl opacity-0 blur-2xl bg-gradient-to-r
                                        from-brand-500/10 via-brand-500/5 to-transparent transition duration-300"
                                        :class="isRoleActive({{ role.role_id }}) ? 'opacity-200' : 'opacity-0'">
                                    </div>
                                    <!-- Card -->
                                    <div class="relative rounded-2xl bg-white dark:bg-[#151c2a]
                                        border p-6 hover:shadow-[0_6px_18px_rgba(0,0,0,0.06)]
                                        transition-all duration-300
                                        "
                                        :class="isRoleActive({{ role.role_id }}) 
                                            ? 'shadow-[0_12px_32px_rgba(0,0,0,0.10)] border-brand-500 dark:border-brand-400' 
                                            : 'border-slate-200/80 dark:border-slate-700/60 shadow-[0_2px_8px_rgba(0,0,0,0.04)]'"
                                    >
                                        <div class="flex flex-col gap-5 space-y-3">
                                            <!-- Top Row -->
                                            <div class="flex items-start justify-between gap-4">
                                                <!-- Role -->
                                                <div class="flex items-start gap-4">
                                                    <!-- Selection Indicator -->
                                                    <div 
                                                        class="flex size-9 shrink-0 items-center justify-center
                                                            rounded-xl shadow-sm transition"
                                                        :class="isRoleActive({{ role.role_id }})
                                                            ? 'bg-brand-500 text-white'
                                                            : 'bg-slate-100 dark:bg-slate-800 text-slate-400'"
                                                    >
                                                        <span class="material-symbols-outlined text-[18px]">
                                                            work_outline
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <h4 class="font-semibold text-slate-900 dark:text-gray-200 leading-tight">
                                                            {{ role.niche_name }}
                                                        </h4>
                                                        <p class="text-sm text-slate-500 dark:text-slate-400">
                                                            {{ role.role_name }}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="text-sm text-gray-500 dark:text-gray-400 text-justify">{{ role.description|truncatewords:35|capfirst }}</p>
                                            <!-- Budget Row (Always Inline) -->
                                            <div class="grid grid-cols-2 md:grid-cols-3 items-center justify-evenly gap-4">
                                                <!-- Budget Allocation -->
                                                <div class="">
                                                    <p class="text-[10px] uppercase tracking-wide font-medium text-slate-400">
                                                        Budget Allocation
                                                    </p>
                                                    <p class="text-base font-normal text-slate-900 dark:text-gray-200">
                                                        ${{ role.budget|intcomma }}
                                                    </p>
                                                </div>
                                                
                                                {% if negotiating %}
                                                <!-- Proposed Amount -->
                                                <div class="w-40">
                                                    <label class="text-[10px] uppercase tracking-wide
                                                        font-medium text-slate-400 block mb-1">
                                                        Proposed Amount
                                                    </label>
                                                    <div class="relative">
                                                        <span class="absolute left-3 top-1/2 
                                                            -translate-y-1/2 text-slate-400 dark:text-gray-300 font-semibold">$</span>
                                                        <input
                                                            type="number"
                                                            name="proposed_amount"
                                                            :class="isFieldDisabled( {{ role.role_id }}, {{ role.can_apply|yesno:'true,false' }}) ? 'cursor-not-allowed opacity-60 bg-slate-100' : 'cursor-pointer'"
                                                            :disabled="isFieldDisabled({{ role.role_id }}, {{ role.can_apply|yesno:'true,false' }})"
                                                            @change="updateRoleField({{ role.role_id }}, 'proposed_amount', $event.target.value)"
                                                            value="{{ role.budget|intcomma }}"
                                                            class="w-full pl-7 pr-3 py-2.5
                                                                rounded-xl bg-slate-50 dark:bg-slate-800    
                                                                border border-slate-200 dark:border-slate-700
                                                                text-sm font-normal text-slate-700 dark:text-gray-300
                                                                focus:outline-none focus:ring-0
                                                                focus:border-brand-500
                                                                transition-colors duration-200
                                                            "
                                                        />
                                                    </div>
                                                </div>
                                                {% endif %}

                                                {# Gigs with roles #}
                                                <div x-data="renderPaymentPlans({{ role.can_apply|yesno:'true,false' }})">
                                                    <p class="mb-1 text-[10px] uppercase tracking-wide font-medium text-slate-400">
                                                        Payment Plan
                                                    </p>
                                                    {% if not negotiating %}
                                                        <select 
                                                            disabled
                                                            class="w-full h-12 rounded-xl border border-slate-200 dark:border-slate-700 
                                                                bg-slate-100 dark:bg-slate-900 text-slate-500 dark:text-slate-500 
                                                                px-4 text-sm font-normal cursor-not-allowed opacity-75"
                                                        >
                                                            <option selected x-text="plans.find(p => p.value === '{{ role.payment_option }}')?.label || '{{ role.payment_option }}'"></option>
                                                        </select>
                                                    {% else %}
                                                        <select 
                                                            x-model="selectedPaymentPlan"
                                                            class="w-full h-12 rounded-xl
                                                                bg-slate-50 dark:bg-slate-800
                                                                border border-slate-200 dark:border-slate-700
                                                                px-4 text-sm font-normal text-slate-700 dark:text-gray-300
                                                                focus:outline-none focus:ring-0
                                                                focus:ring-brand-500/25
                                                                focus:border-brand-500 transition"
                                                            :class="!canSelect ? 'cursor-not-allowed opacity-60 bg-slate-100' : 'cursor-pointer'"
                                                            :disabled="!canSelect"
                                                            @change="updateRoleField({{ role.role_id }}, 'payment_plan', $event.target.value)"
                                                        >
                                                            <option value="">select option</option>
                                                            <template x-for="plan in plans" :key="plan.value">
                                                                <option :value="plan.value" x-text="plan.label"></option>
                                                            </template>
                                                        </select>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                {# When project/gig has no specific roles #}
                <div class="relative">
                    <!-- Ambient Frame -->
                    <div
                        class="absolute -inset-1 rounded-3xl
                            bg-gradient-to-r from-slate-200/40 via-white/20 to-slate-200/40
                            dark:from-slate-800/40 dark:via-slate-900/10 dark:to-slate-800/40
                            blur-xl">
                    </div>

                    <!-- Card -->
                    <div
                        class="relative rounded-3xl bg-white dark:bg-[#151c2a]
                            border border-slate-200/80 dark:border-slate-700/60
                            shadow-[0_6px_18px_rgba(0,0,0,0.05)]
                            p-6 lg:p-8">

                        <!-- Header -->
                        <div class="mb-8">
                            <h4 class="text-base font-semibold text-slate-800 dark:text-white mb-3">
                                Define Your Role for This Project
                            </h4>
                            <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xl">
                                Choose the industry and specialization that best matches your contribution.
                                Then enter the amount you’d like to receive for this role.
                            </p>
                        </div>

                        <!-- Fields -->
                        <div x-data="taxonomyPicker()" x-ref="projectRole" class="grid grid-cols-1 md:grid-cols-3 gap-5">

                            <!-- Industry -->
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wide font-medium
                                        text-slate-400 block mb-1"
                                >Industry</label>

                                <select
                                    x-model="selectedIndustryId"
                                    class="w-full h-12 rounded-xl
                                        bg-slate-50 dark:bg-slate-800
                                        border border-slate-200 dark:border-slate-700
                                        px-4 text-sm font-normal text-slate-800 dark:text-gray-300
                                        focus:ring-0 focus:ring-brand-500/25
                                        focus:border-brand-500 transition"
                                    >
                                        <option value="">Select industry</option>
                                        <template x-for="item in industries" :key="item.id">
                                            <option :value="item.id" x-text="item.name"></option>
                                        </template>
                                </select>
                            </div>

                            <!-- Niche -->
                            <div>
                                <label
                                    class="text-[10px] uppercase tracking-wide font-medium
                                        text-slate-400 block mb-1"
                                >Specialization</label>

                                <select
                                    class="w-full h-12 rounded-xl bg-slate-100
                                        dark:bg-slate-800 border border-slate-200
                                        dark:border-slate-700 focus:ring-0 focus:ring-brand-500/25
                                        focus:border-brand-500 transition
                                        px-4 text-sm font-normal text-slate-400"
                                    :class="!selectedIndustryId ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-gray-300 border border-slate-200 dark:border-slate-700'"
                                    :disabled="!selectedIndustryId"
                                    x-model="selectedNicheId"
                                >
                                    <option value="" x-text="!selectedIndustryId ? 'Select industry first' : 'Select specialization'"></option>
                                    <template x-for="sub in filteredSubcategories()" :key="sub.id">
                                        <option :value="sub.id" x-text="sub.name"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- Price -->
                            <div>
                                <label class="text-[10px] uppercase tracking-wide font-medium
                                    text-slate-400 block mb-1"
                                >Proposed Amount</label>

                                <div class="relative">
                                    <span
                                        class="absolute left-3 top-1/2 -translate-y-1/2
                                            text-slate-400 font-semibold"
                                    >$</span>

                                    <input
                                        x-model="roleAmount"
                                        type="number"
                                        @change="getSummary()"
                                        placeholder="0.00"
                                        class="w-full h-12 pl-7 rounded-xl
                                            bg-slate-50 dark:bg-slate-800
                                            border border-slate-200 dark:border-slate-700
                                            text-sm font-medium text-slate-800 dark:text-gray-300
                                            focus:outline-none
                                            focus:ring-0 focus:ring-brand-500/25
                                            focus:border-brand-500 transition"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </section>
            {% if not gig.required_roles.all %}
            <!-- Payment Plan -->
            <section class="relative">
                <!-- Ambient Frame -->
                <div class="absolute -inset-1 rounded-3xl
                    bg-gradient-to-r from-slate-200/40 via-white/20 to-slate-200/40
                    dark:from-slate-800/40 dark:via-slate-900/10 dark:to-slate-800/40
                    blur-xl"
                ></div>
                <!-- Card -->
                <div class="relative rounded-3xl shadow-sm
                    bg-white dark:bg-[#151c2a] p-6 lg:p-8
                    border border-slate-200 dark:border-slate-700"
                >
                    <div class="flex flex-col gap-6">

                        <!-- Header -->
                        <div>
                            <h3 class="text-base font-semibold
                            text-slate-900 dark:text-white">
                                Payment Structure
                            </h3>

                            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400 max-w-lg">
                                Choose how you'd like payments released throughout the project.
                            </p>
                        </div>

                        <!-- Grid -->
                        <div 
                            
                            class="grid grid-cols-1 lg:grid-cols-[1fr_auto] gap-6 items-end"
                        >
                            {# For gigs without roles #}
                            <div x-data="renderPaymentPlans(true)"  x-ref="gigPaymentPlan" class="flex flex-col gap-2">
                                <label class="text-xs font-medium uppercase tracking-wide
                                text-slate-500 dark:text-slate-400">
                                    Percentage Split
                                </label>
                                <select
                                    x-model="selectedPaymentPlan"
                                    class="w-full h-12 rounded-xl
                                        bg-slate-50 dark:bg-slate-800
                                        border border-slate-200 dark:border-slate-700
                                        px-4 text-sm font-normal text-slate-700 dark:text-gray-300
                                        focus:outline-none focus:ring-0
                                        focus:ring-brand-500/25
                                        focus:border-brand-500 transition"
                                >
                                    <option value="">select option</option>
                                    <template x-for="plan in plans" :key="plan.value">
                                        <option :value="plan.value" x-text="plan.label"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- Info Panel -->
                            <div class="rounded-2xl
                                bg-success-25 dark:bg-slate-800/50
                                border border-success-100 dark:border-slate-700
                                px-4 py-3 text-sm max-w-sm
                                text-emerald-500/60 dark:text-slate-400"
                            >
                                Funds are released according to your agreed payment plan and set dates.
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            {% endif %}
            <section class="relative">
                <!-- Ambient Frame -->
                <div class="absolute -inset-1 rounded-3xl
                    bg-gradient-to-r from-slate-200/40 via-white/20 to-slate-200/40
                    dark:from-slate-800/40 dark:via-slate-900/10 dark:to-slate-800/40
                    blur-xl">
                </div>

                <!-- Card -->
                <div class="relative rounded-3xl shadow-sm
                    bg-white dark:bg-[#151c2a] p-6 lg:p-8
                    border border-slate-200 dark:border-slate-700">
                    <div class="flex flex-col gap-7">
                        <!-- Header -->
                        <div class=>
                            <h3 class="text-base font-semibold text-slate-900 dark:text-white mb-2">
                                Deliverables & Timeline
                            </h3>

                            <p class="mt-1 text-sm text-slate-500 font-normal dark:text-slate-400 max-w-lg text-justify">
                                Outline what you’ll deliver and how long each stage will take. Clear milestones speed up approvals and payments.
                            </p>
                        </div>

                        <!-- Deliverables Builder -->
                        <div x-data="deliverablesManager()" x-ref="deliverablesUnit" class="flex flex-col gap-5">
                            <template x-for="(item, index) in items" :key="item.id">
                                <!-- Milestone Row -->
                                <div
                                    class="group relative rounded-2xl
                                        bg-slate-50 dark:bg-slate-800/60
                                        border border-slate-200 dark:border-slate-700
                                        p-4 transition hover:shadow-sm">

                                    <div class="grid grid-cols-1 gap-4">
                                        <button x-show="items.length > 1" @click="removeItem(item.id)" 
                                            class="absolute -top-2 -right-2 size-6 bg-red-100 text-error-500 rounded-full flex items-center justify-center hover:bg-red-200 transition">
                                            <span class="material-symbols-outlined text-xs">close</span>
                                        </button>
                                        <div>
                                            <label class="text-[10px] uppercase tracking-wide font-medium text-slate-400 block mb-1">
                                                Deliverable Title <span class="text-error-500">*</span>
                                            </label>

                                            <input
                                                type="text"
                                                x-model="item.title"
                                                @input="item.title.length > 50 ? item.title = item.title.substring(0, 50) : null"
                                                placeholder="e.g. System Architecture Design"
                                                class="w-full h-12 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 px-4 text-sm font-normal text-slate-700 dark:text-gray-300 focus:outline-none focus:border-brand-500 focus:ring-0 transition-colors duration-200"
                                            />
                                            <span :class="item.title.length >= 50 ? 'text-error-500' : 'text-slate-400'" 
                                                class="text-[9px] font-mono pl-3">
                                                <span x-text="item.title.length"></span>/50
                                            </span>
                                        </div>
                                        <div>
                                            <label class="text-[10px] uppercase tracking-wide font-medium text-slate-400 block mb-1">
                                                Deliverable Description <span class="text-error-500">*</span>
                                            </label>
                                            <textarea
                                                rows="8"
                                                x-model="item.description"
                                                placeholder="e.g. Homepage design, API integration, campaign strategy..."
                                                class="w-full resize-none rounded-xl
                                                    bg-white dark:bg-slate-900
                                                    border border-slate-200 dark:border-slate-700
                                                    px-4 py-3 text-sm font-normal text-slate-700 dark:text-gray-300
                                                    focus:outline-none focus:border-brand-500 focus:ring-0
                                                    transition-colors duration-200"
                                            ></textarea>
                                        </div>

                                        <!-- Duration & Due Date side by side -->
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">

                                            <!-- Duration -->
                                            <div>
                                                <label class="text-[10px] uppercase tracking-wide font-medium text-slate-400 block mb-1">
                                                    Duration <span class="text-error-500">*</span>
                                                </label>
                                                <select
                                                    x-model="item.unit"                                     
                                                    class="w-full h-12 rounded-xl
                                                        bg-white dark:bg-slate-900
                                                        border border-slate-200 dark:border-slate-700
                                                        px-3 text-sm font-normal text-slate-700 dark:text-gray-300
                                                        focus:outline-none focus:border-brand-500 focus:ring-0
                                                        transition-colors duration-200"
                                                >
                                                    <option value="days">Days</option>
                                                    <option value="weeks">Weeks</option>
                                                    <option value="months">Months</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label class="text-[10px] uppercase tracking-wide font-medium text-slate-400 block mb-1">
                                                    Value <span class="text-error-500">*</span>
                                                </label>
                                                <select
                                                    x-model="item.value"
                                                    class="w-full h-12 rounded-xl
                                                        bg-white dark:bg-slate-900
                                                        border border-slate-200 dark:border-slate-700
                                                        px-3 text-sm font-normal text-slate-700 dark:text-gray-300
                                                        focus:outline-none focus:border-brand-500 focus:ring-0
                                                        transition-colors duration-200"
                                                >
                                                    <template x-for="num in getValueOptions(item.unit)" :key="num">
                                                        <option :value="num" x-text="num + ' ' + (num > 1 ? item.unit : item.unit.replace(/s$/, ''))"></option>
                                                    </template>
                                                </select>
                                            </div>

                                            <!-- Due Date -->
                                            <div>
                                                <label class="text-[10px] uppercase tracking-wide font-medium text-slate-400 block mb-1">
                                                    Due by <span class="text-error-500">*</span>
                                                </label>
                                                <input
                                                    type="date"
                                                    x-model="item.due_by"
                                                    class="w-full h-12 rounded-xl
                                                        bg-white dark:bg-slate-900 placeholder:text-xs
                                                        border border-slate-200 dark:border-slate-700
                                                        px-3 text-sm font-normal text-slate-700 dark:text-gray-300
                                                        focus:outline-none focus:border-brand-500 focus:ring-0
                                                        transition-colors duration-200"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Add Deliverable -->
                            <button
                                type="button"
                                @click="addDeliverable()"
                                class="group inline-flex items-center gap-2 self-start
                                    px-4 py-2.5 rounded-xl
                                    bg-brand-50 dark:bg-brand-500/10
                                    text-brand-600 dark:text-gray-400
                                    text-sm font-medium dark:hover:text-gray-300
                                    hover:bg-brand-100 dark:hover:bg-gray-500/20
                                    transition">

                                <span class="material-symbols-outlined text-[18px]">
                                    add_circle
                                </span>

                                Add another deliverable
                            </button>

                        </div>

                        <!-- Guidance -->
                        <div
                            class="flex items-start gap-3 rounded-2xl
                                bg-slate-50 dark:bg-slate-800/50
                                border border-slate-100 dark:border-slate-700
                                p-4">

                            <span
                                class="material-symbols-outlined text-[18px]
                                    text-gray-500">
                                schedule
                            </span>

                            <p
                                class="text-sm text-slate-500 dark:text-slate-400 max-w-xl">
                                Break work into clear stages. Smaller deliverables reduce approval delays and
                                increase client confidence during the project.
                            </p>

                        </div>

                    </div>

                </div>
            </section>
        </div>
        <div class="flex flex-col gap-6 lg:sticky lg:top-24">
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-xl overflow-hidden">
                <div class="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/20">
                    <h3 class="text-slate-500 text-sm font-medium leading-normal">Your Proposal Summary</h3>
                </div>
                <div class="p-6 flex flex-col gap-6">
                    <div id="proposalSummary" class="flex flex-col gap-4">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500">Selected Roles (<span id="summary-count">0</span>)</span>
                            <span id="summary-subtotal" class="text-slate-900 dark:text-gray-400 font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500">Service Fee (5%)</span>
                            <span id="summary-fee" class="text-slate-900 dark:text-gray-400 font-semibold">$0.00</span>
                        </div>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center">
                            <span class="text-base font-semibold text-slate-900 dark:text-gray-300">Total Proposal</span>
                            <span id="summary-total" class="text-2xl font-semibold text-brand-500 dark:text-gray-200">$0.00</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 px-4 py-3 bg-green-50 dark:bg-green-900/10 rounded-xl border border-green-100 dark:border-green-900/20">
                        <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-xl">verified_user</span>
                        <div class="flex flex-col">
                            <span class="text-[10px] font-black text-green-700 dark:text-green-400 uppercase tracking-widest leading-none mb-0.5">Escrow Protection</span>
                            <span class="text-[11px] text-green-600/80 dark:text-green-400/80 leading-tight">Funds are secured before work starts.</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4" x-data="{ agreed: false }">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input 
                                x-model="agreed" 
                                class="mt-1 size-4 rounded border-slate-300 dark:border-slate-700 
                                    text-brand-500 focus:ring-brand-500" 
                                type="checkbox"
                            />
                            <span class="text-[11px] text-slate-500 leading-normal group-hover:text-slate-700 dark:group-hover:text-slate-300 transition-colors">
                                I agree to the <a class="text-brand-500 dark:text-brand-300 font-semibold underline" href="#">Terms of Engagement</a> and confirm that I can meet the project deadlines.
                            </span>
                        </label>
                        <button 
                            id="sndProposalBtn"
                            type="button"
                            @click="sendProposal()"
                            :disabled="!agreed"
                            :class="agreed ? 'bg-brand-500 shadow-brand-500/30 hover:bg-brand-500/90 active:scale-[0.98]' : 'bg-brand-500/30 cursor-not-allowed shadow-none'"
                            class="w-full py-4 text-white rounded-xl font-semibold text-base shadow-lg transition-all flex items-center justify-center gap-2">
                            <span>Send Proposal</span>
                            <span class="material-symbols-outlined text-xl">send</span>
                        </button>
                        <p class="text-[10px] text-center text-slate-400 px-4">
                            The client will have 72 hours to review and accept your proposal.
                        </p>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-brand50 dark:bg-slate-800/50 rounded-xl border border-dashed border-slate-300 dark:border-slate-700">
                <div class="flex gap-3">
                    <span class="material-symbols-outlined text-brand-500 dark:text-brand-400">info</span>
                    <div class="flex flex-col gap-1">
                        <p class="text-xs font-semibold text-brand-700 dark:text-brand-400">First time applying?</p>
                        <p class="text-[11px] text-brand-500/90 dark:text-brand-400/90">Read our guide on how to craft a winning proposal and secure roles faster.</p>
                        <a class="text-[11px] font-semibold text-brand-500 dark:text-brand-400 mt-1 hover:underline" href="#">Read Guide</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block custom_page_js %}
<script id="taxonomy-data" type="application/json" x-ref="taxonomy">
{{ taxonomy_json|safe }}
</script>
<script id="payment-options-data" type="application/json" x-ref="paymentPlans">
  {{ payment_options|safe }}
</script>
<script>
document.querySelectorAll(".role-checkbox").forEach(cb => {
    cb.addEventListener("click", (e) => {
        if (cb.dataset.canApply === "false") {
            e.preventDefault();
            e.stopPropagation();

            showToast(
                "You can’t apply for this role because it doesn’t match your expertise.",
                "info",
                "Ineligible Role"
            );
        }
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="{% static 'js/utils/sendRequest.js' %}"></script>
<script src="{% static 'js/utils/updateProposalUI.js' %}"></script>
<script src="{% static 'js/utils/renderIndustryTaxonomy.js' %}"></script>
<script src="{% static 'js/utils/renderPaymentOptions.js' %}"></script>
<script src="{% static 'js/collaboration/managers/deliverables.js' %}"></script>
<script src="{% static 'js/collaboration/managers/roleApplication.js' %}"></script>
<script src="{% static 'js/collaboration/accept-offer.js' %}"></script>
{% endblock %}