{% extends "layouts/base.html" %}
{% load static %}
{% block custom_page_css %}
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
{% endblock %}
{% block browser_title %}Project Info{% endblock %}
{% block content %}

<div data-gig-data x-data="gigData()" data-endpoint="{% url COLLABORATION_URLS.CREATE_COLLABORATION %}" data-csrf-token="{{ csrf_token }}" class="py-3">
    <div class="flex-1 w-full pb-32">
        <div class="mx-auto w-full max-w-[1600px] flex flex-col gap-8">
            <div class="flex flex-col gap-3">
                <h1 class="text-gray-800 dark:text-gray-300 text-title-sm md:text-title-md font-semibold leading-tight tracking-[-0.033em]">Create New Gig/Project</h1>
                <p class="text-title-xs md:text-sm text-gray-800 dark:text-gray-400">Broadcast your project to thousands of verified professionals.</p>
            </div>
            <form action="#" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                <div class="lg:col-span-8 flex flex-col gap-6">
                    <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-gray-100 dark:border-[#2d3748] overflow-hidden">
                        <div class="border-b border-gray-100 dark:border-[#2d3748] px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="p-2 rounded-md bg-blue-50 dark:bg-blue-600/30 text-blue-700 dark:text-blue-400">
                                    <span class="material-symbols-outlined text-[20px]">article</span>
                                </div>
                                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Project Information</h3>
                            </div>
                            <span class="text-xs font-medium text-warning-500 bg-warning-50 dark:bg-warning-400/30 px-2 py-1 rounded-full">not saved</span>
                        </div>
                        <div class="p-6 flex flex-col gap-6">
                            <div class="flex flex-col gap-2">
                                <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">Gig / Project Title</label>
                                <input x-model="payload.title" class="dark:bg-dark-900 shadow-theme-xs focus:border-success-300
                                        dark:focus:border-warning-200 focus:ring-success-500/10
                                        dark:focus:ring-warning-300/10 h-11 w-full rounded-lg
                                        border border-gray-300 bg-transparent px-4 py-5 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30" placeholder="e.g., Enterprise SaaS Redesign for Fintech App" type="text" />
                            </div>
                            <div class="flex flex-col md:flex-row md:items-end gap-6">
                                <!-- Project Budget -->
                                <div class="flex flex-col gap-2 w-full md:w-1/3">
                                    <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">
                                        Project Budget
                                    </label>
                                    <div class="relative w-full">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-sm font-semibold pointer-events-none">
                                            $
                                        </span>
                                        <input 
                                            x-model="payload.projectBudget"
                                            :disabled="budgetLocked"
                                            :class="budgetLocked
                                                ? 'cursor-not-allowed opacity-60 bg-gray-100 dark:bg-gray-800'
                                                : ''"
                                            type="number"
                                            value=""
                                            placeholder="5,000"
                                            class="
                                                w-full rounded-md border border-[#cfd7e7] 
                                                dark:border-[#4a5568] bg-white dark:bg-[#2d3748]
                                                text-gray-800 dark:text-gray-400
                                                pl-7 pr-3 py-2.5 text-sm
                                                focus:outline-none focus:ring-1
                                                focus:ring-success-500/30
                                                focus:border-success-500
                                            " />
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2 w-fit">
                                    <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">Visibility</label>
                                    <div class="relative flex bg-[#f8f9fc] dark:bg-[#2d3748] p-1 rounded-lg border border-[#cfd7e7] dark:border-[#4a5568] w-fit">
                                        <!-- Sliding background -->
                                        <div class="absolute top-1 left-1 h-[calc(100%-0.5rem)] w-[47%] bg-white dark:bg-gray-100 rounded-lg shadow-sm transition-all duration-300" :class="payload.visibility === 'private' ? 'translate-x-full' : 'translate-x-0'">
                                        </div>

                                        <!-- Buttons -->
                                        <button @click="payload.visibility='public'" :class="payload.visibility === 'public' ? 'text-gray-800 dark:text-gray-700 font-semibold' : 'text-gray-600 dark:text-gray-400 font-medium'" class="relative px-4 py-2 rounded-md text-sm transition-colors" type="button">
                                            Public
                                        </button>
                                        <button @click="payload.visibility='private'" :class="payload.visibility === 'private' ? 'text-gray-800 dark:text-gray-700 font-semibold' : 'text-gray-600 dark:text-gray-400 font-medium'" class="relative px-4 py-2 rounded-md text-sm transition-colors" type="button">
                                            Private
                                        </button>
                                    </div>
                                </div>

                            </div>
                            <div x-init="initQuill()" class="flex flex-col gap-2">
                                <label class="text-gray-700 dark:text-gray-400 text-sm font-semibold">Project Description</label>
                                <div class="
                                    rounded-lg border border-gray-300 dark:border-gray-700
                                    bg-[#f8f9fc] dark:bg-gray-900 shadow-theme-xs transition-all
    
                                    focus-within:border-success-500 focus-within:ring-3
                                        focus-within:ring-success-400/20
    
                                        dark:focus-within:border-warning-200
                                        dark:focus-within:ring-warning-200/25
                                    "
                                >
                                    <!-- Toolbar -->
                                    <div 
                                        id="quill-toolbar" 
                                        class="flex flex-wrap items-center gap-x-2 gap-y-2 p-2 border-b 
                                            border-slate-200 dark:border-slate-700 
                                            bg-slate-100 dark:bg-slate-800 dark:text-gray-400"
                                    >
                                        <!-- Header -->
                                        <div class="relative">
                                            <select class="ql-header">
                                                <option selected value="">Small</option>
                                                <option value="2">Big</option>
                                                <option value="3">Medium</option>
                                            </select>
                                        </div>

                                        <!-- Buttons -->
                                        <button class="ql-bold quill-btn"><span class="material-symbols-outlined">format_bold</span></button>
                                        <button class="ql-italic quill-btn"><span class="material-symbols-outlined">format_italic</span></button>
                                        <button class="ql-underline quill-btn"><span class="material-symbols-outlined">format_underlined</span></button>

                                        <!-- Alignment -->
                                        <button class="ql-align quill-btn" value="">
                                            <span class="material-symbols-outlined">format_align_left</span>
                                        </button>
                                        <button class="ql-align quill-btn" value="center">
                                            <span class="material-symbols-outlined">format_align_center</span>
                                        </button>
                                        <button class="ql-align quill-btn" value="right">
                                            <span class="material-symbols-outlined">format_align_right</span>
                                        </button>
                                        <button class="ql-align quill-btn" value="justify">
                                            <span class="material-symbols-outlined">format_align_justify</span>
                                        </button>

                                        <!-- Bullet list-->
                                        <button class="ql-list quill-btn" value="bullet">
                                            <span class="material-symbols-outlined">format_list_bulleted</span>
                                        </button>

                                    </div>
                                    <div id="quill-editor" class="w-full min-h-[200px] p-4 bg-transparent text-gray-800 dark:text-gray-400"></div>
                                    <!-- <textarea
                                        x-model="payload.description" 
                                        @input="enforceDescriptionLimit()"
                                        class="w-full border-none
                                            bg-transparent p-4
                                            min-h-[160px]
                                            text-gray-800 dark:text-gray-400
                                            placeholder:text-gray-500
    
                                            focus:outline-none
                                            focus:ring-0
                                            focus:border-transparent
                                        " placeholder="Describe the project goals, deliverables, and any specific requirements..."></textarea> -->
                                </div>
                                <p
                                    class="text-xs text-right"
                                    :class="descriptionCount() >= maxDescriptionLength
                                        ? 'text-red-500'
                                        : 'text-slate-500'"
                                >
                                    <span x-text="descriptionCount()"></span>/<span x-text="maxDescriptionLength"></span>
                                    characters
                                    <!-- <span x-text="maxDescriptionLength - descriptionCount()"></span> remaining -->
                                </p>
                            </div>
                            <div class="flex items-center gap-3 pl-3">
                                <label class="text-sm font-medium text-gray-800 dark:text-gray-400">
                                    Allow Negotiation
                                </label>

                                <div class="flex items-center gap-4">
                                    <!-- YES -->
                                    <label
                                        class="relative flex cursor-pointer items-center gap-3 text-sm font-medium select-none"
                                        :class="payload.isNegotiable
                                            ? 'text-gray-700 dark:text-gray-300'
                                            : 'text-gray-500 dark:text-gray-400'"
                                    >
                                        <input
                                            type="radio"
                                            class="sr-only"
                                            name="isNegotiable"
                                            :checked="payload.isNegotiable === true"
                                            @change="payload.isNegotiable = true"
                                        />

                                        <span
                                            class="flex h-5 w-5 items-center justify-center rounded-full border-[1.25px]"
                                            :class="payload.isNegotiable
                                                ? 'border-brand-500 bg-brand-500'
                                                : 'bg-transparent border-gray-300 dark:border-gray-700'"
                                        >
                                            <span
                                                class="h-2 w-2 rounded-full bg-white"
                                                x-show="payload.isNegotiable"
                                            ></span>
                                        </span>

                                        Yes
                                    </label>

                                    <!-- NO -->
                                    <label
                                        class="relative flex cursor-pointer items-center gap-3 text-sm font-medium select-none"
                                        :class="!payload.isNegotiable
                                            ? 'text-gray-700 dark:text-gray-300'
                                            : 'text-gray-500 dark:text-gray-400'"
                                    >
                                        <input
                                            type="radio"
                                            class="sr-only"
                                            name="roleSelect"
                                            :checked="payload.isNegotiable === false"
                                            @change="payload.isNegotiable = false"
                                        />

                                        <span
                                            class="flex h-5 w-5 items-center justify-center rounded-full border-[1.25px]"
                                            :class="!payload.isNegotiable
                                                ? 'border-brand-500 bg-brand-500'
                                                : 'bg-transparent border-gray-300 dark:border-gray-700'"
                                        >
                                            <span
                                                class="h-2 w-2 rounded-full bg-white"
                                                x-show="!payload.isNegotiable"
                                            ></span>
                                        </span>

                                        No
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div x-data="gigRoles($refs.taxonomy, $refs.paymentSplitData)" data-gig-roles class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-gray-100 dark:border-[#2d3748] overflow-hidden">
                        <div class="border-b border-gray-100 dark:border-[#2d3748] px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="p-2 rounded-lg bg-orange-50 dark:bg-orange-900/30 text-orange-600">
                                    <span class="material-symbols-outlined text-[20px]">group</span>
                                </div>
                                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Required Professionals</h3>
                            </div>
                            <button @click="addRole()" class="text-gray-500 hover:text-brand-500 dark:text-gray-500 dark:hover:text-gray-200 text-sm font-semibold flex items-center gap-1" type="button">
                                <span class="material-symbols-outlined text-[18px]">add</span>
                                <span class="hidden sm:inline">Add Role</span>
                            </button>
                        </div>
                        <div class="p-6 flex flex-col gap-6">
                            <template x-for="(role, index) in roles" :key="index">
                                <div class="border border-[#cfd7e7] dark:border-[#4a5568] rounded-lg p-5 relative bg-[#fcfcfd] dark:bg-[#232a3b] group hover:border-brand-500/50 transition-colors">
                                    <button @click="removeRole(index)" class="absolute top-2 right-2 mr-2 text-[#9ca3af] hover:text-red-500 transition-colors p-1">
                                        <span class="material-symbols-outlined text-[20px]">delete</span>
                                    </button>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-4">
                                        <div class="flex flex-col gap-2">
                                            <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">Niche</label>
                                            <select 
                                                x-model="role.nicheId" 
                                                @change="role.professionalId = ''; emitRoles()" 
                                                class="w-full rounded-md border border-[#cfd7e7]
                                                    dark:border-[#4a5568] bg-white dark:bg-[#2d3748]
                                                    text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm
                                                    focus:outline-none focus:ring-1 focus:ring-success-500/30
                                                    focus:border-success-500 transition
                                                ">
                                                <option>Select niche</option>
                                                <template x-for="niche in taxonomy" :key="niche.id">
                                                    <option :value="niche.id" x-text="niche.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-gray-700 dark:text-gray-400 text-xs font-semibold uppercase tracking-wider text-opacity-50">professional</label>
                                            <select x-model="role.professionalId" @change="emitRoles()" :disabled="!role.nicheId" class="w-full rounded-md border border-[#cfd7e7] dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm focus:outline-none focus:ring-1 focus:ring-success-500/30 focus:border-success-500 transition">
                                                <option>Select Specialization</option>
                                                <template x-for="pro in professionalsFor(role.nicheId)" :key="pro.id">
                                                    <option :value="pro.id" x-text="pro.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-gray-700 dark:text-gray-500 text-xs font-semibold uppercase tracking-wider text-opacity-70">Budget Allocation</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-600 text-sm font-semibold">$</span>
                                                <input type="number" x-model="role.budget" @change="emitRoles()" placeholder="5000" class="w-full rounded-md border border-[#cfd7e7] dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-gray-800 dark:text-gray-400 pl-7 pr-3 py-2.5 text-sm focus:outline-none focus:ring-1 focus:ring-success-500/30 focus:border-success-500" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                                        <div class="md:col-span-2 flex flex-col gap-2">
                                            <label class="text-gray-800 dark:text-gray-500 text-xs font-semibold uppercase tracking-wider text-opacity-70">Role Description</label>
                                            <input type="text" x-model="role.description" @change="emitRoles()" placeholder="e.g., Enterprise SaaS Redesign for Fintech App" class="w-full rounded-md border border-[#cfd7e7] dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm focus:outline-none focus:ring-1 focus:ring-success-500/30 focus:border-success-500 transition" />
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-gray-700 dark:text-gray-500 text-xs font-semibold uppercase tracking-wider text-opacity-70">Payment Option</label>
                                            <select x-model="role.paymentOption" @change="emitRoles()" class="w-full rounded-md border border-[#cfd7e7] dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-gray-800 dark:text-gray-400 px-3 py-2.5 text-sm focus:outline-none focus:ring-1 focus:ring-success-500/30 focus:border-success-500 transition">
                                                <option>Choose payment Option</option>
                                                <template x-for="option in paymentOptions" :key="option.value">
                                                    <option :value="option.value" x-text="option.label"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <button @click="addRole()" class="flex items-center justify-center gap-2 w-full py-3 border-2 border-dashed border-gray-300 dark:border-gray-500 rounded-lg text-gray-400 hover:text-brand-500 dark:text-gray-500 dark:hover:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-colors" type="button">
                                <span class="material-symbols-outlined text-[20px]">add_circle</span>
                                Add another role
                            </button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-4 flex flex-col gap-6 lg:sticky lg:top-24">
                    <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-gray-100 dark:border-[#2d3748] overflow-hidden">
                        <div class="border-b border-gray-100 dark:border-[#2d3748] px-6 py-4 flex items-center gap-2">
                            <div class="p-2 rounded-lg bg-purple-50 dark:bg-purple-900/30 text-purple-600">
                                <span class="material-symbols-outlined text-[20px]">calendar_month</span>
                            </div>
                            <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Project Timeline</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 gap-6">
                            <!--Working calendar engine -->
                            <div 
                                
                                x-data="calendarEngine()"
                                
                            >
                                <!--Start Date-->
                                <div class="flex flex-col gap-3 space-y-3 mb-5"> <label class="text-center text-gray-800 dark:text-gray-800 text-sm font-semibold bg-slate-200 rounded-lg py-3 px-4 mb-3">Proposed Start Date</label>
                                    <div x-data="{ type: 'start' }">
                                        <!-- Header-->
                                        <div class="flex items-center justify-between mb-2"> 
                                            <button 
                                                type="button" 
                                                @click="prevMonth(type)" 
                                                class="text-gray-600 dark:text-gray-400 
                                                    text-sm px-2 py-1 rounded hover:bg-gray-200"
                                            > ‹ </button>
                                            <span 
                                                class="text-sm font-semibold text-gray-600 
                                                    dark:text-gray-500" 
                                                x-text="monthLabel(type)"></span>
                                            <button type="button" 
                                                @click="nextMonth(type)" 
                                                class="text-gray-600 dark:text-gray-400 
                                                    text-sm px-2 py-1 rounded hover:bg-gray-200"> › </button>
                                        </div>
                                        <div class="grid grid-cols-7 text-center text-xs font-semibold mb-1">
                                            <template x-for="day in weekDays" :key="day">
                                                <div x-text="day" class="text-gray-600 dark:text-gray-500"></div>
                                            </template>
                                        </div>
                                        <!--Days of the month-->
                                        <div class="grid grid-cols-7 gap-1 mb-3">
                                            <template x-for="day in daysInMonth(type)" :key="day.dateObj ? day.dateObj.getTime() : 'empty-' + index">
                                                <div>
                                                    <button 
                                                        type="button" 
                                                        x-show="!day.empty" 
                                                        @click="selectDate(day.dateObj, type)" 
                                                        x-text="day.date" 
                                                        :disabled="day.disabled" 
                                                        :class="{ 
                                                            'bg-brand-500 text-white font-bold shadow-md': isSelected(day.dateObj, type), 
                                                            'text-gray-400 dark:text-gray-600 cursor-not-allowed opacity-40': day.disabled,
                                                            'text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-brand-300 dark:hover:bg-brand-600': !day.disabled && !isSelected(day.dateObj, type)
                                                        }" 
                                                        class="w-8 h-8 rounded-full text-sm hover:bg-brand-300 transition">
                                                    </button>
                                                </div>
                                            </template> </div>
                                    </div>
                                </div> <!-- End date -->
                                <div class="flex flex-col gap-2"> <label class="text-center text-gray-800 dark:text-gray-800 text-sm font-semibold bg-slate-200 rounded-lg py-3 px-4 mb-3">Target Delivery / Go Live</label>
                                    <div x-data="{ type: 'end' }">
                                        <!-- Header-->
                                        <div class="flex items-center justify-between mb-2">
                                            <button 
                                                type="button"
                                                @click="prevMonth(type)" 
                                                class="text-gray-600 dark:text-gray-400 text-sm px-2 
                                                py-1 rounded hover:bg-gray-200"
                                            > ‹ </button>
                                            <span 
                                                class="text-sm font-semibold text-gray-600 
                                                    dark:text-gray-500" 
                                                x-text="monthLabel(type)"
                                            ></span> 
                                            <button 
                                                type="button" 
                                                @click="nextMonth(type)" 
                                                class="text-gray-600 dark:text-gray-400 
                                                    text-sm px-2 py-1 rounded hover:bg-gray-200"
                                            > › </button>
                                        </div>
                                        <div class="grid grid-cols-7 text-center text-xs font-semibold mb-1"> 
                                            <template x-for="day in weekDays" :key="day">
                                                <div x-text="day" class="text-gray-600 dark:text-gray-500"></div>
                                            </template>
                                        </div>
                                        <!--Days of the month-->
                                        <div class="grid grid-cols-7 gap-1"> 
                                            <template x-for="day in daysInMonth(type)" :key="day.dateObj ? day.dateObj.getTime() : 'empty-' + index">
                                                <div>
                                                    <button 
                                                        type="button" 
                                                        x-show="!day.empty" 
                                                        @click="selectDate(day.dateObj, type)" 
                                                        x-text="day.date" 
                                                        :disabled="day.disabled" 
                                                        :class="{ 
                                                            'bg-brand-500 text-white font-bold shadow-md': isSelected(day.dateObj, type), 
                                                            'text-gray-400 dark:text-gray-600 cursor-not-allowed opacity-40': day.disabled,
                                                            'text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-brand-300 dark:hover:bg-brand-600': !day.disabled && !isSelected(day.dateObj, type)
                                                        }"
                                                        class="w-8 h-8 rounded-full text-sm hover:bg-blue-200 transition">
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-[#f8f9fc] dark:bg-[#2d3748] rounded-lg border border-[#cfd7e7] dark:border-[#4a5568]">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-gray-800 dark:text-gray-400">Enable Project Milestones</span>
                                    <span class="py-1.5 text-xs text-gray-500">Break down payment and delivery into phases</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input checked="" class="sr-only peer" type="checkbox" value="" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-gray-100 dark:border-[#2d3748] overflow-hidden">
                        <div class="border-b border-gray-100 dark:border-[#2d3748] px-6 py-4 flex items-center gap-2">
                            <div class="p-2 rounded-lg bg-green-50 dark:bg-green-900/30 text-green-600">
                                <span class="material-symbols-outlined text-[20px]">payments</span>
                            </div>
                            <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Budget Breakdown</h3>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-col gap-6">
                                <!-- Total Budget -->
                                <div class="flex items-end gap-3">
                                    <span
                                        class="text-title-lg font-extrabold text-gray-700 dark:text-gray-300 tracking-tight"
                                        x-text="`$${Number(payload.projectBudget).toLocaleString()}`"
                                    ></span>
                                    <span class="text-[12px] text-gray-600 mb-1.5 font-medium">
                                        Project/Gig Budget
                                    </span>
                                </div>

                                <!-- Budget Distribution Bar -->
                                <div class="w-full h-4 rounded-full bg-[#f0f2f5] dark:bg-[#2d3748] flex overflow-hidden">
                                    <template
                                        x-for="(role, index) in payload.roles.filter(r => r.professional && r.budget > 0)"
                                        :key="index"
                                    >
                                        <div
                                            class="h-full"
                                            :class="roleColors[index % roleColors.length]"
                                            :style="`width: ${(role.budget / payload.projectBudget) * 100}%`"
                                        ></div>
                                    </template>
                                </div>

                                <!-- Role Breakdown -->
                                <div class="flex flex-col gap-3">
                                    <template
                                        x-for="(role, index) in payload.roles.filter(r => r.professional && r.budget > 0)"
                                        :key="index"
                                    >
                                        <div class="flex items-center gap-2">
                                            <div
                                                class="size-3 rounded-full"
                                                :class="roleColors[index % roleColors.length]"
                                            ></div>

                                            <span class="text-sm text-gray-800 dark:text-gray-400">
                                                <span x-text="role.professional"></span>
                                                <span
                                                    class="text-[#4c669a] ml-1"
                                                    x-text="`($${Number(role.budget).toLocaleString()})`"
                                                ></span>
                                            </span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- <div class="flex flex-col gap-6">
                                <div class="flex items-end gap-3">
                                    <span
                                        class="text-title-lg font-extrabold text-gray-700 dark:text-gray-300 tracking-tight"
                                        x-text="`$${Number(payload.projectBudget).toLocaleString()}`"
                                    >$9,500</span>
                                    <span class="text-xs lg:text-sm text-gray-600 mb-1.5 font-medium">Total required Budget</span>
                                </div>
                                <div class="w-full h-4 rounded-full bg-[#f0f2f5] dark:bg-[#2d3748] flex overflow-hidden">
                                    <div class="h-full bg-success-400" style="width: 52%"></div>
                                    <div class="h-full bg-gray-300 dark:bg-gray-600" style="width: 48%"></div>
                                </div>
                                <div class="flex flex-col gap-3">
                                    <div class="flex items-center gap-2">
                                        <div class="size-3 rounded-full bg-success-400"></div>
                                        <span class="text-sm text-gray-800 dark:text-gray-400">Product Designer <span class="text-[#4c669a] ml-1">($5,000)</span></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="size-3 rounded-full bg-blue-500"></div>
                                        <span class="text-sm text-gray-800 dark:text-gray-400">Frontend Dev <span class="text-[#4c669a] ml-1">($4,500)</span></span>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>
                    <!-- <div class="bg-white dark:bg-[#1a202c] rounded-xl shadow-sm border border-gray-100 dark:border-[#2d3748] overflow-hidden">
                        <div class="border-b border-gray-100 dark:border-[#2d3748] px-6 py-4 flex items-center gap-2">
                            <div class="p-2 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                                <span class="material-symbols-outlined text-[20px]">settings</span>
                            </div>
                            <h3 class="text-base font-semibold text-gray-700 dark:text-gray-300">Broadcast Settings</h3>
                        </div>
                        <div class="p-6 flex flex-col gap-4">
                            <label class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-[#f8f9fc] dark:hover:bg-[#2d3748] transition-colors">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-gray-800 dark:text-gray-400">Notify professionals</span>
                                    <span class="py-1.5 text-xs text-gray-500">Send alerts to all matching talent in selected niches</span>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input checked="" class="sr-only peer" type="checkbox" value="" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                </div>
                            </label>
                            <div class="h-px bg-[#e7ebf3] dark:bg-[#2d3748]"></div>
                            <label class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-[#f8f9fc] dark:hover:bg-[#2d3748] transition-colors">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-gray-800 dark:text-gray-400">Allow negotiation</span>
                                    <span class="py-1.5 text-xs text-gray-500">Talent can propose different budget or timeline</span>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input checked="" class="sr-only peer" type="checkbox" value="" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                </div>
                            </label>
                            <div class="h-px bg-[#e7ebf3] dark:bg-[#2d3748]"></div>
                            <label class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-[#f8f9fc] dark:hover:bg-[#2d3748] transition-colors">
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-gray-800 dark:text-gray-400">Allow partial acceptance</span>
                                    <span class="py-1.5 text-xs text-gray-500">Professionals can apply for just one role</span>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input class="sr-only peer" type="checkbox" value="" />
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
                                </div>
                            </label>
                        </div>
                    </div> -->
                </div>
            </form>
        </div>
    </div>

    <!--Bottom navifation-->
    <!-- Bottom Action Bar -->
    <div class="w-full inset-x-0 bottom-0 z-60
        backdrop-blur-xl rounded-xl
        bg-white/80 dark:bg-[#0f172a]/80
        border-t border-white/10
        shadow-[0_-10px_30px_rgba(59,130,246,0.08)]
        px-4 sm:px-6 py-4
        pb-[calc(env(safe-area-inset-bottom)+1rem)]">

        <div class="max-w-[1600px] mx-auto flex items-center gap-4">
            
            <!-- Estimated total -->
            <div class="hidden sm:flex flex-col">
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    Estimated Total
                </span>

                <span 
                    x-text="`$${Number(budgetLocked ? rolesTotalAmount : payload.projectBudget).toLocaleString()}`"
                    class="text-lg font-semibold text-slate-900 dark:text-slate-200"
                >
                    $9,500
                    <span class="text-xs font-normal text-slate-500">USD</span>
                </span>
            </div>

            <!-- Actions -->
            <div
                class="flex items-center gap-3 ml-auto"
                x-data="{ busyPublish: false, busyDraft: false }"
            >

                <!-- Save Draft -->
                <button
                    type="button"
                    @click="
                        if (busyDraft) return;
                        busyDraft = true;
                        submitBtn('draft').finally(() => busyDraft = false)
                    "
                    :disabled="busyDraft || busyPublish"
                    class="px-5 py-2.5 rounded-lg
                        border border-slate-200 dark:border-slate-700
                        bg-white dark:bg-slate-800
                        text-slate-800 dark:text-slate-300
                        text-sm font-semibold
                        hover:bg-slate-50 dark:hover:bg-slate-700
                        transition
                        disabled:opacity-60 disabled:cursor-not-allowed"
                >
                    Save as Draft
                </button>

                <!-- Publish Gig -->
                <button
                    @click="
                        if (busyPublish) return;
                        busyPublish = true;
                        submitBtn('publish').finally(() => busyPublish = false)
                    "
                    :disabled="busyDraft || busyPublish"
                    type="button"
                    class="flex items-center gap-2
                        px-6 py-2.5 rounded-lg
                        text-white text-sm font-semibold
                        shadow-lg shadow-brand-500/30
                        transition
                        disabled:opacity-60 disabled:cursor-not-allowed
                        bg-brand-500 hover:bg-brand-600"
                >
                    <span
                        class="material-symbols-outlined text-[18px]"
                        :class="{ 'animate-spin': busyPublish }"
                        x-text="busyPublish ? 'autorenew' : 'send'"
                    ></span>

                    <span x-text="busyPublish ? 'Publishing…' : 'Publish Gig'"></span>
                </button>

            </div>
        </div>
    </div>

    <!-- <div class="fixed inset-x-0 bottom-0 z-[60]
             bg-white dark:bg-[#1a202c]
             border-t border-[#e7ebf3] dark:border-[#2d3748]
             shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]
             px-4 sm:px-6 py-4 pb-[calc(env(safe-area-inset-bottom)+1rem)]"
        >
        <div class="max-w-[1600px] mx-auto flex items-center gap-4">
            <!-- Estimated total --
            <div class="hidden sm:flex flex-col">
                <span class="text-xs font-semibold text-[#4c669a] uppercase tracking-wider">
                    Estimated Total
                </span>
                <span 
                    x-text="`$${Number(budgetLocked ? rolesTotalAmount : payload.projectBudget).toLocaleString()}`"
                    class="text-lg font-semibold text-gray-800 dark:text-gray-400">
                    $9,500
                    <span class="text-xs font-normal text-[#4c669a]">USD</span>
                </span>
            </div>
            <!-- Actions --
            <div
                class="flex items-center gap-3 ml-auto"
                x-data="{ busyPublish: false, busyDraft: false }"
            >
                <!-- Save Draft -
                <button
                    type="button"
                    @click="
                        if (busyDraft) return;
                        busyDraft = true;
                        submitBtn('draft').finally(() => busyDraft = false)
                    "
                    :disabled="busyDraft || busyPublish"
                    class="px-5 py-2.5 rounded-lg
                        border border-[#cfd7e7] dark:border-[#4a5568]
                        bg-white dark:bg-[#2d3748]
                        text-gray-800 dark:text-gray-400
                        text-sm font-semibold
                        hover:bg-[#f8f9fc] dark:hover:bg-[#4a5568]
                        transition
                        disabled:opacity-60 disabled:cursor-not-allowed"
                >
                    Save as Draft
                </button>

                <!-- Publish Gig -
                <button
                    @click="
                        if (busyPublish) return;
                        busyPublish = true;
                        submitBtn('publish').finally(() => busyPublish = false)
                    "
                    :disabled="busyDraft || busyPublish"
                    type="button"
                    class="flex items-center gap-2
                        px-5 py-2.5 rounded-lg
                        text-white text-sm font-semibold
                        shadow-md transition
                        disabled:opacity-60 disabled:cursor-not-allowed
                        bg-brand-500 hover:bg-brand-600"
                >
                    <span
                        class="material-symbols-outlined text-[18px]"
                        :class="{ 'animate-spin': busyPublish }"
                        x-text="busyPublish ? 'autorenew' : 'send'"
                    ></span>

                    <span x-text="busyPublish ? 'Publishing…' : 'Publish Gig'"></span>
                </button>
            </div>
        </div>
    </div> -->
</div>

{% endblock %}
{% block custom_page_js %}
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script id="gig-taxonomy-data" type="application/json" x-ref="taxonomy">
{{ gig_taxonomy|safe }}
</script>
<script id="payment-options-data" type="application/json" x-ref="paymentSplitData">
  {{ payment_options|safe }}
</script>
<script>
// working calendar engine
    function calendarEngine() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const normalize = (d) => {
            const x = new Date(d);
            x.setHours(0, 0, 0, 0);
            return x;
        };

        return {
            // independent views
            startView: new Date(today),
            endView: new Date(today),

            selectedStart: null,
            selectedEnd: null,

            weekDays: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],

            nextMonth(type) {
                if (type === 'start') {
                    this.startView = new Date(
                        this.startView.getFullYear(),
                        this.startView.getMonth() + 1,
                        1
                    );
                } else {
                    this.endView = new Date(
                        this.endView.getFullYear(),
                        this.endView.getMonth() + 1,
                        1
                    );
                }
            },

            prevMonth(type) {
                const currentMonthStart = new Date(
                    today.getFullYear(),
                    today.getMonth(),
                    1
                );

                const view = type === 'start' ? this.startView : this.endView;

                const prev = new Date(
                    view.getFullYear(),
                    view.getMonth() - 1,
                    1
                );

                // block navigating before current month
                if (prev < currentMonthStart) return;

                if (type === 'start') {
                    this.startView = prev;
                } else {
                    this.endView = prev;
                }
            },

            daysInMonth(type) {
                const view = type === 'start' ? this.startView : this.endView;

                const year = view.getFullYear();
                const month = view.getMonth();

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                const days = [];

                for (let i = 0; i < firstDay.getDay(); i++) {
                    days.push({
                        empty: true
                    });
                }

                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const dateObj = normalize(new Date(year, month, d));

                    days.push({
                        date: d,
                        dateObj,
                        disabled: this.isDisabled(dateObj, type)
                    });
                }

                return days;
            },

            isDisabled(date, type) {
                if (type === 'start') {
                    return date < today;
                }

                if (type === 'end') {
                    if (!this.selectedStart) return true;

                    const minEnd = new Date(this.selectedStart);
                    minEnd.setDate(minEnd.getDate() + 1);

                    return date < minEnd;
                }

                return false;
            },

            selectDate(date, type) {
                if (this.isDisabled(date, type)) return;

                if (type === 'start') {
                    this.selectedStart = normalize(date);
                    this.selectedEnd = null;

                    // IMPORTANT: reassign, don't mutate
                    this.endView = new Date(
                        date.getFullYear(),
                        date.getMonth(),
                        1
                    );
                }

                if (type === 'end') {
                    this.selectedEnd = normalize(date);
                }
                this.emitDates();
            },

            isSelected(date, type) {
                if (!date) return false; 

                const selected =
                    type === 'start'
                        ? this.selectedStart
                        : this.selectedEnd;

                return selected && selected.getTime() === date.getTime();
            },

            monthLabel(type) {
                const view = type === 'start' ? this.startView : this.endView;
                return view.toLocaleDateString(undefined, {
                    month: 'long',
                    year: 'numeric'
                });
            },

            emitDates() {
                const gig = Alpine.$data(
                    document.querySelector('[data-gig-data]')
                );

                if (!gig) {
                    showToast('Incomplete initialization of gig data', 'warning', 'Initialization Error');
                    return;
                }

                const formatDate = (date) => {
                    if (!date) return null;

                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                };

                gig.payload.startDate = this.selectedStart
                    ? formatDate(this.selectedStart)
                    : null;

                gig.payload.endDate = this.selectedEnd
                    ? formatDate(this.selectedEnd)
                    : null;

            },
        };
    }
</script>
<script>
    // working gig roles
    function gigRoles(taxonomyEl, paymentOptionsEl) {
        return {
            taxonomy: JSON.parse(taxonomyEl.textContent),
            paymentOptions: JSON.parse(paymentOptionsEl.textContent),
            roles: [{
                nicheId: '',
                nicheName: '',
                professionalId: '',
                professionalName: '',
                budget: 0,
                description: '',
                paymentOption: ''
            }],

            professionalsFor(nicheId) {
                return this.taxonomy.find(n => n.id == nicheId)?.subcategories || [];
            },

            addRole() {
                this.roles.push({
                    nicheId: '',
                    nicheName: '',
                    professionalId: '',
                    professionalName: '',
                    budget: 0,
                    description: '',
                    paymentOption: ''
                });
                this.emitRoles();
            },

            removeRole(index) {
                this.roles.splice(index, 1);
                this.emitRoles();
            },

            getNicheById(id) {
                return this.taxonomy.find(n => n.id == id);
            },

            getProfessionalById(nicheId, proId) {
                const niche = this.getNicheById(nicheId);
                return niche?.subcategories?.find(p => p.id == proId);
            },

            emitRoles() {
                // Find the parent gigData component anywhere on the page
                const gigEl = document.querySelector('[data-gig-data]');
                if (!gigEl) {
                    showToast(
                        "We couldn’t prepare your gig details. Please refresh the page and try again.",
                        "info",
                        "Page Error"
                    )
                    return;
                }

                const gig = Alpine.$data(gigEl);
                if (!gig || typeof gig.setRoles !== 'function') {
                    showToast(
                        "This page is missing required gig data. Please reload or contact support if the issue persists.",
                        "info",
                        "Configuration Error"
                    )
                    return;
                }

                const payload = this.roles.map(role => {
                    const niche = this.getNicheById(role.nicheId);
                    const professional = this.getProfessionalById(role.nicheId, role.professionalId);

                    return {
                        nicheId: niche?.id || null,
                        niche: niche?.name || null,
                        professionalId: professional?.id || null,
                        professional: professional?.name || null,
                        budget: Number(role.budget) || 0,
                        description: role.description?.trim() || '',
                        paymentOption: role.paymentOption
                    };
                });

                gig.setRoles(payload);
            },

            totalRolesBudget() {
                return this.roles.reduce(
                    (sum, r) => sum + (Number(r.budget) || 0),
                    0
                );
            },

            
        }
    }
</script>
<script src="{% static 'js/collaboration/create-gig.js' %}"></script>
{% endblock %}